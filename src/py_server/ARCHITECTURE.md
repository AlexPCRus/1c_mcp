# Архитектура MCP-прокси сервера

Этот документ описывает архитектуру Python части MCP-прокси сервера, структуру модулей, их ответственность и взаимодействие.

## 📁 Структура модулей

```
src/py_server/
├── __init__.py              # Инициализация пакета
├── __main__.py              # Точка входа для запуска как модуля
├── main.py                  # CLI интерфейс и основная логика запуска
├── config.py                # Конфигурация и настройки
├── onec_client.py           # HTTP-клиент для взаимодействия с 1С
├── mcp_server.py            # Основной MCP-сервер и прокси логика
├── http_server.py           # HTTP-сервер с поддержкой SSE
├── stdio_server.py          # Stdio сервер для MCP-клиентов
├── test_client.py           # Тестовый клиент для отладки
├── demo_*.py                # Демонстрационные скрипты
├── requirements.txt         # Зависимости Python
├── env.example              # Пример конфигурации
└── README.md                # Документация пользователя
```

## 🏗️ Архитектурная диаграмма

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   MCP Client    │    │   MCP Client    │    │   Web Client    │
│  (Claude, etc)  │    │   (Cursor)      │    │  (Browser)      │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │ stdio                │ stdio                │ HTTP+SSE
          │                      │                      │
          └──────────────────────┼──────────────────────┘
                                 │
                    ┌────────────▼────────────┐
                    │     MCP Proxy Server    │
                    │    (Python FastAPI)     │
                    └────────────┬────────────┘
                                 │ HTTP
                                 │
                    ┌────────────▼────────────┐
                    │    1C HTTP Service      │
                    │   /hs/mcp/manifest      │
                    │   /hs/mcp/rpc           │
                    └─────────────────────────┘
```

## 📋 Модули и их ответственность

### 1. `config.py` - Конфигурация системы

**Ответственность:**
- Определение настроек приложения через Pydantic
- Валидация параметров конфигурации
- Загрузка настроек из переменных окружения

**Основные классы:**
- `Config` - модель конфигурации с валидацией

**Функции:**
- `get_config()` - фабрика для создания конфигурации

**Взаимодействие:**
- Используется всеми остальными модулями для получения настроек
- Читает переменные окружения с префиксом `MCP_`

```python
# Пример использования
config = get_config()
print(config.onec_url)  # http://localhost/base
```

### 2. `onec_client.py` - HTTP-клиент для 1С

**Ответственность:**
- HTTP-взаимодействие с 1С
- Преобразование данных между форматами 1С и MCP
- Обработка ошибок подключения к 1С

**Основные классы:**
- `OneCClient` - асинхронный HTTP-клиент для 1С

**Методы:**
- `get_manifest()` - получение манифеста от 1С
- `call_rpc()` - выполнение JSON-RPC запросов
- `list_tools()` - получение списка инструментов
- `call_tool()` - вызов инструмента
- `list_resources()` - получение списка ресурсов
- `read_resource()` - чтение ресурса
- `list_prompts()` - получение списка промптов
- `get_prompt()` - получение промпта

**Взаимодействие:**
- Используется `MCPProxy` для проксирования запросов
- Формирует URL по схеме `/hs/{service_root}/{endpoint}`
- Преобразует ответы 1С в типы MCP

```python
# Пример использования
client = OneCClient("http://localhost/base", "user", "pass", "mcp")
tools = await client.list_tools()
result = await client.call_tool("get_customers", {"limit": 10})
```

### 3. `mcp_server.py` - Основной MCP-сервер

**Ответственность:**
- Реализация протокола MCP
- Проксирование запросов между MCP-клиентами и 1С
- Управление жизненным циклом соединений

**Основные классы:**
- `MCPProxy` - основной класс MCP-сервера

**Методы:**
- `_lifespan()` - управление жизненным циклом
- `_register_handlers()` - регистрация обработчиков MCP
- `get_capabilities()` - получение capabilities сервера
- `get_initialization_options()` - опции инициализации

**Обработчики MCP:**
- `handle_list_tools()` - список инструментов
- `handle_call_tool()` - вызов инструмента
- `handle_list_resources()` - список ресурсов
- `handle_read_resource()` - чтение ресурса
- `handle_list_prompts()` - список промптов
- `handle_get_prompt()` - получение промпта

**Взаимодействие:**
- Использует `OneCClient` для взаимодействия с 1С
- Используется `MCPHttpServer` и `run_stdio_server`
- Преобразует MCP-запросы в вызовы 1С и обратно

```python
# Пример использования
proxy = MCPProxy(config)
# Сервер автоматически регистрирует обработчики MCP
```

### 4. `http_server.py` - HTTP-сервер с SSE

**Ответственность:**
- HTTP-сервер для веб-клиентов
- Реализация SSE (Server-Sent Events) транспорта
- Обработка CORS и веб-безопасности

**Основные классы:**
- `MCPHttpServer` - HTTP-сервер с поддержкой MCP

**Endpoints:**
- `GET /` - информация о сервере
- `GET /health` - проверка состояния
- `GET /sse` - SSE подключение для MCP
- `POST /messages` - отправка сообщений MCP

**Методы:**
- `_register_routes()` - регистрация HTTP маршрутов
- `handle_sse()` - обработка SSE подключений
- `handle_messages()` - обработка POST сообщений
- `start()` - запуск HTTP-сервера

**Взаимодействие:**
- Использует `MCPProxy` для обработки MCP-запросов
- Управляет SSE транспортами для каждого клиента
- Интегрируется с FastAPI и uvicorn

```python
# Пример использования
server = MCPHttpServer(config)
await server.start()  # Запуск на http://localhost:8000
```

### 5. `stdio_server.py` - Stdio сервер

**Ответственность:**
- Реализация stdio транспорта для MCP
- Взаимодействие с MCP-клиентами через stdin/stdout

**Функции:**
- `run_stdio_server()` - запуск stdio сервера

**Взаимодействие:**
- Использует `MCPProxy` для обработки MCP-запросов
- Используется MCP-клиентами типа Claude Desktop, Cursor

```python
# Пример использования
await run_stdio_server(config)
```

### 6. `main.py` - CLI интерфейс и запуск

**Ответственность:**
- Парсинг аргументов командной строки
- Управление запуском в разных режимах
- Обработка ошибок и логирование

**Функции:**
- `setup_logging()` - настройка логирования
- `create_parser()` - создание парсера CLI
- `main()` - основная функция запуска

**Режимы запуска:**
- `stdio` - для MCP-клиентов
- `http` - для веб-клиентов

**Взаимодействие:**
- Создает конфигурацию из аргументов и переменных окружения
- Запускает соответствующий сервер (`stdio_server` или `http_server`)

```bash
# Примеры использования
python -m src.py_server stdio --onec-url http://localhost/base
python -m src.py_server http --port 8000
```

### 7. `test_client.py` - Тестовый клиент

**Ответственность:**
- Тестирование подключения к 1С
- Проверка работы MCP-прокси
- Отладка и диагностика

**Функции:**
- `test_onec_connection()` - тест подключения к 1С
- `test_mcp_stdio()` - тест MCP через stdio
- `test_http_server()` - тест HTTP-сервера

**Взаимодействие:**
- Использует `OneCClient` для прямого тестирования 1С
- Использует MCP SDK для тестирования прокси

## 🔄 Поток данных

### Stdio режим (Claude Desktop, Cursor):
```
MCP Client → stdin → MCPProxy → OneCClient → 1C HTTP Service
MCP Client ← stdout ← MCPProxy ← OneCClient ← 1C HTTP Service
```

### HTTP режим (веб-клиенты):
```
Web Client → HTTP POST → MCPHttpServer → MCPProxy → OneCClient → 1C
Web Client ← SSE ← MCPHttpServer ← MCPProxy ← OneCClient ← 1C
```

## 🎯 Принципы архитектуры

### 1. **Разделение ответственности**
- Каждый модуль имеет четко определенную роль
- Минимальная связанность между модулями
- Максимальная когезия внутри модулей

### 2. **Асинхронность**
- Все I/O операции асинхронные
- Поддержка множественных подключений
- Эффективное использование ресурсов

### 3. **Конфигурируемость**
- Все настройки через переменные окружения
- Валидация конфигурации при запуске
- Гибкость развертывания

### 4. **Расширяемость**
- Легко добавить новые типы транспортов
- Поддержка новых типов контента MCP
- Модульная архитектура

### 5. **Отказоустойчивость**
- Обработка ошибок на всех уровнях
- Логирование для диагностики
- Graceful shutdown

## 🔧 Зависимости между модулями

```
main.py
├── config.py
├── http_server.py
│   ├── mcp_server.py
│   │   └── onec_client.py
│   └── config.py
└── stdio_server.py
    ├── mcp_server.py
    │   └── onec_client.py
    └── config.py
```

## 📊 Метрики и мониторинг

### Логирование:
- `DEBUG` - детальная информация о запросах/ответах
- `INFO` - события жизненного цикла, подключения
- `WARNING` - неизвестные типы контента, предупреждения
- `ERROR` - ошибки подключения, валидации, выполнения

### Health check:
- `GET /health` - проверка состояния сервера и подключения к 1С
- Статусы: `healthy`, `starting`, `unhealthy`

## 🚀 Точки расширения

### 1. **Новые транспорты**
- WebSocket транспорт
- gRPC транспорт
- TCP транспорт

### 2. **Новые типы контента**
- Аудио контент
- Видео контент
- Структурированные данные

### 3. **Аутентификация**
- OAuth 2.0
- JWT токены
- API ключи

### 4. **Кэширование**
- Кэш манифестов
- Кэш ресурсов
- Кэш результатов инструментов

### 5. **Мониторинг**
- Prometheus метрики
- Distributed tracing
- Performance monitoring

Эта архитектура обеспечивает гибкость, масштабируемость и простоту сопровождения MCP-прокси сервера. 