# Разработка MCP-серверов в 1С

Инструмент для создания MCP (Model Context Protocol) серверов на платформе 1С:Предприятие. Позволяет разрабатывать расширения 1С, которые предоставляют данные и функциональность базы для AI-ассистентов (Claude, Cursor и других).

Поддерживаются три варианта подключения MCP-клиентов:

**Через Python-прокси (рекомендуется):**
- **stdio** - для нативных MCP-клиентов (Claude Desktop, Cursor)
- **HTTP** - для веб-приложений и кастомных интеграций (с поддержкой SSE для совместимости)

**Прямое подключение к 1С (ограниченная функциональность):**
- **HTTP** - упрощенный вариант без прокси (может не поддерживаться всеми клиентами)

Проект включает готовый пример MCP-сервера и инфраструктуру для разработки собственных инструментов, ресурсов и промптов.

## Зачем нужен прокси?

В 1С:Предприятие на данный момент невозможно реализовать полноценный MCP-сервер без внешнего прокси по следующим причинам:

- **Отсутствие поддержки консольных приложений** - в 1С нельзя создать приложение, работающее через stdio
- **Ограниченные возможности HTTP-сервисов** - нет поддержки современных протоколов для двусторонней связи с клиентами

Поэтому используется архитектура с Python-прокси:

```
# Через прокси (полная функциональность)
AI-клиент ←→ MCP-прокси (Python) ←→ HTTP-сервис 1С

# Прямое подключение (базовая функциональность)
AI-клиент ←→ HTTP-сервис 1С
```

## Компоненты проекта

- **`src/py_server/`** - MCP-прокси сервер на Python
- **`src/1c_ext/`** - Расширение для 1С с HTTP-сервисом и инструментами (готовый пример)
- **`mcp_client_settings/`** - Примеры настроек подключения MCP-сервера для разных MCP-клиентов

## Быстрый старт

### 1. Требования

- Python 3.11+ (рекомендуется использовать 3.13)
- 1С:Предприятие 8.3.20+
- Возможность публикации HTTP-сервисов из базы
- Rust toolchain (может потребоваться для компиляции Python-зависимостей)

### 2. Установка Python-прокси

Клонируйте репозиторий и установите зависимости в виртуальном окружении:

```bash
# Клонирование репозитория
git clone https://github.com/vladimir-kharin/1c_mcp.git
cd 1c_mcp

# Создание виртуального окружения
python -m venv venv

# Активация (Windows)
venv\Scripts\activate
# Активация (Linux/Mac)
source venv/bin/activate

# Установка зависимостей
pip install -r src/py_server/requirements.txt
```

## 3. Настройка

**Для режима HTTP** создайте файл `.env` в корне проекта:

```bash
# Скопируйте пример настроек (Windows)
copy src\py_server\env.example .env
# Или (Linux/Mac)
cp src/py_server/env.example .env
```

**Для режима stdio** настройки удобнее задавать непосредственно в конфигурации MCP-клиента через переменные окружения - это позволяет использовать разные настройки для разных проектов без создания отдельных `.env` файлов.

Отредактируйте `.env` (или настройки клиента) с параметрами вашей базы 1С:

```ini
MCP_ONEC_URL=http://localhost/your_base_name
MCP_ONEC_USERNAME=your_username
MCP_ONEC_PASSWORD=your_password
MCP_ONEC_SERVICE_ROOT=mcp
MCP_LOG_LEVEL=INFO
```

### 4. Запуск

```bash
# Для MCP-клиентов (stdio режим)
python -m src.py_server

# Для веб-приложений (HTTP режим)
python -m src.py_server http --port 8000

# Прямое подключение к 1С (без прокси)
# Клиенты подключаются напрямую к:
# http://your_1c_base_url/hs/mcp/
```

## Варианты подключения

### Прямое подключение к 1С (упрощенный)

**Преимущества:**
- Не требует запуска Python-прокси

**Ограничения:**
- База должна быть опубликована с "вшитой" в публикацию авторизацией (чтобы не требовалася basic-авторизация)
- Нет возможности реализовать streaming и real-time обновления
- Ограниченная совместимость с некоторыми клиентами

**Endpoint:** `http://your_1c_base_url/hs/mcp/mcp`

### Через Python-прокси (полная функциональность)

**Преимущества:**
- Полная поддержка MCP протокола
- Максимальная совместимость с клиентами
- Дополнительные транспорты (stdio, SSE)

**Требует:** Запуск Python-прокси

## Подключение к AI-клиентам

В папке [`mcp_client_settings/`](./mcp_client_settings/) находятся примеры настроек для различных клиентов:

- **Claude Desktop** - см. `mcp_client_settings/claude_desktop/`
- **Cursor** - см. `mcp_client_settings/cursor/`

Каждый клиент имеет свои особенности подключения и конфигурации.

## Решение проблем (Troubleshooting)

### Ошибки при установке зависимостей

**Проблема:** Ошибки типа "Rust not found" или "metadata-generation-failed"
```
Cargo, the Rust package manager, is not installed or is not on PATH.
```

**Решение:** Установите Rust любым из простых способов:
- **WinGet**: `winget install Rustlang.Rustup`
- **Сайт**: Скачайте с https://rustup.rs/

После установки перезапустите терминал/IDE.

**Проблема:** Конфликты версий пакетов
```
ERROR: Cannot install ... because these package versions have conflicting dependencies.
```

**Решение:** Обновите pip и попробуйте установку заново:
```bash
python -m pip install --upgrade pip
pip install -r src/py_server/requirements.txt
```

**Проблема:** Долгая установка или зависание
```
INFO: This is taking longer than usual...
```

**Решение:** Попробуйте установить с использованием только готовых binary wheels:
```bash
pip install --only-binary=all -r src/py_server/requirements.txt
```

### Проблемы запуска

**Проблема:** Ошибки импорта модулей
```
ModuleNotFoundError: No module named 'src'
```

**Решение:** Убедитесь, что запускаете команды из корневой папки проекта и виртуальное окружение активировано.

**Проблема:** Ошибки подключения к 1С
```
Connection refused или HTTP 401/403
```

**Решение:** 
1. Проверьте правильность настроек в `.env` файле
2. Убедитесь, что HTTP-сервисы опубликованы в базе 1С
3. Проверьте доступность базы по указанному URL

## Реализация MCP-сервера в 1С

### Архитектура расширения

1С-расширение содержит:

- **HTTP-сервис `mcp_APIBackend`** - универсальный JSON-RPC обработчик (не требует доработки, используется как есть)
- **Обработки-контейнеры** - реализуют конкретные инструменты, ресурсы и промпты

**Готовый пример:** В репозитории уже реализован рабочий пример с инструментами для анализа метаданных конфигурации:
- Получение списка объектов метаданных с фильтром по типу и имени (синониму)
- Подробное описание структуры выбранного объекта метаданных (реквизиты, табличные части и т.д.)

### Создание инструментов

Для создания нового инструмента:

1. Создайте обработку (например, `mcp_ИмяНабораИнструментов`)
2. Включите её в подсистему `mcp_КонтейнерыИнструментов`
3. Реализуйте в модуле менеджера два метода:

```bsl
Процедура ДобавитьИнструменты(Инструменты) Экспорт
	// Формирование списка инструментов и описания их параметров
КонецПроцедуры

Функция ВыполнитьИнструмент(ИмяИнструмента, Аргументы) Экспорт
	// Роутинг вызовов в зависимости от ИмяИнструмента конкретных методов, реализующих тот или иной инструмент
КонецФункции
```

### Типы MCP-примитивов

Расширение поддерживает все типы MCP-примитивов:

- **Tools (Инструменты)** - функции для выполнения действий в 1С
- **Resources (Ресурсы)** - данные для предоставления контекста
- **Prompts (Промпты)** - шаблоны сообщений с параметрами

Подробная документация по архитектуре и разработке инструментов находится в [`src/1c_ext/agents.md`](./src/1c_ext/agents.md). Если будете разрабатывать с использованием ИИ-инструментов - подгружайте этот файл в контекст.

## Документация

- **[Концепция проекта](./doc/concept.md)** - общая архитектура и принципы
- **[Документация Python-прокси](./src/py_server/README.md)** - детальное описание прокси-сервера
- **[Архитектура 1С-расширения](./src/1c_ext/agents.md)** - подробности реализации на стороне 1С
- **[Примеры настроек клиентов](./mcp_client_settings/)** - конфигурации для разных AI-клиентов

## Лицензия

MIT License

## Поддержка и развитие

Проект активно развивается. Вопросы и предложения по улучшению приветствуются через Issues. 